//Copyright (c) 2014 by Disy Informationssysteme GmbH
package net.disy.eenvplus.tfes.modules.core;

import static org.apache.commons.lang3.StringUtils.isNotBlank;
import net.disy.eenvplus.tfes.core.api.exceptions.ServiceException;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import com.hp.hpl.jena.query.Query;
import com.hp.hpl.jena.query.QueryExecution;
import com.hp.hpl.jena.query.QueryExecutionFactory;
import com.hp.hpl.jena.query.ResultSet;
import com.hp.hpl.jena.sparql.engine.http.QueryExceptionHTTP;

// NOT_PUBLISHED
@Component
public class ThesaurusSparqlConnector implements ISparqlConnector {

  @Value("${sparql.endpoint.url}")
  private String sparqlEndpointUrl;

  private static final Logger LOGGER = LoggerFactory.getLogger(ThesaurusSparqlConnector.class);

  @Override
  public ResultSet executeSparqlQuery(Query query) throws ServiceException {
    logQuery(query);
    QueryExecution queryExecution = QueryExecutionFactory.sparqlService(sparqlEndpointUrl, query);
    try {
      ResultSet result = queryExecution.execSelect();
      logResult(query, result);
      return result;
    }
    catch (QueryExceptionHTTP exception) {
      StringBuilder builder = new StringBuilder();
      builder.append('[').append(query.hashCode()).append(']');
      builder.append(" Error in Request to SPARQL endpoint. Response-Code: "); //$NON-NLS-1$
      builder.append(exception.getResponseCode());
      appendMessage(builder, exception.getResponseMessage());
      appendMessage(builder, exception.getLocalizedMessage());
      LOGGER.error(builder.toString());
      throw SparqlExceptionFactory.wrap(sparqlEndpointUrl, exception);
    }
  }

  @SuppressWarnings("nls")
  private void logQuery(Query query) {
    LOGGER.debug("[" + query.hashCode() + "]" + " Executing SparQl-Query:\n" + query.toString());
  }

  @SuppressWarnings("nls")
  private void logResult(Query query, ResultSet result) {
    LOGGER.debug("[" + query.hashCode() + "]" + " Successfully received SparQl Response.");
  }

  private void appendMessage(StringBuilder builder, String message) {
    if (isNotBlank(message)) {
      builder.append('\n');
      builder.append(message);
    }
  }

  @Override
  public String getEndpointUrl() {
    return sparqlEndpointUrl;
  }

}
